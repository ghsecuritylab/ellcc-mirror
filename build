#!/bin/sh
# toplevel ELLCC distribution build script

# Get the staging directory.
prefix=`pwd`

# Figure out the compilers to use.
. ./build-setup $*

# Configure for an LLVM+Clang build.
mkdir -p llvm-build$builddir

make DIR=llvm-build$builddir CC="$cc" CXX="$cxx" AR="$ar" RANLIB="$ranlib" \
     TARGET=$host OS=$os \
     bindir=$bindir prefix=$prefix build=$build haslibs=$haslibs \
     llvm.configure || exit 1

# Build the LLVM tools.
make -C llvm-build$builddir -j 6 || exit 1

# Build the GNU tools.
cd gnu
./build $arg1 || exit 1
cd ..

# Now install the ELLCC tools.
make -j 6 -C llvm-build$builddir install || exit 1

if [ "$host" != "$build" ] ; then
  # The host system is not the build system.
  # No need to build the libraries again.

  echo Configured to $WHY.
  echo C compiler: $cc
  echo C++ compiler: $cxx
  echo In: llvm-build$builddir
  exit 0
fi

# Build libecc.
cd libecc
make clean
make || exit 1
cd ..

if [ "x$hostos" = "xLinux" ] ; then
  if [ "$haslibs" != "yes" ] ; then
    echo "Please run the build script again to bootstrap ecc."
    echo "This may be done a few times:"
    echo "1. ecc is built with itself (compiled with gcc) and libecc."
    echo "2. ecc is built with itself (compiled with itself) and libecc."
  fi
fi
